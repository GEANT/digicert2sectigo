---
- name: "Fetch data for certificate order {{ item }} from Digicert API"
  uri:
    url: "https://www.digicert.com/services/v2/order/certificate/{{ item }}"
    return_content: yes
    headers:
      X-DC-DEVKEY: "{{ digicert_api_key }}"
  register: res


- name: Combine user email with additional_emails
  set_fact:
    mails: "{{ [res.json.user.email] | union(res.json.additional_emails | default([])) }}"

- name: Include mail address mapping
  include_tasks: _map_mails.yml
  when: sectigo_email_map is defined

- name: Mails to be used for new certificate request
  debug:
    var: mails

- pause:
    prompt: |
      commonName: {{ res.json.certificate.common_name }}
      subjAltNames:

      {% for san in res.json.certificate.dns_names %}
       - {{ san }}
      {% endfor %}

      mails:
      {% for mail in mails %}
       - {{ mail }}
      {% endfor %}
  when: confirm|bool

- name: "Request new certificate through Sectigo API (common name: {{ res.json.certificate.common_name }})"
  uri:
    url: https://cert-manager.com/api/ssl/v1/enroll
    return_content: yes
    method: POST
    headers: "{{ sectigo_headers }}"
    body_format: json
    body:
      orgId: "{{ sectigo_orgId }}"
      csr: "{{ res.json.certificate.csr }}"
      commonName: "{{ res.json.certificate.common_name }}"
      subjAltNames: "{{ res.json.certificate.dns_names|join(',') }}"
      term: "{{ sectigo_cert_term }}"
      certType: "{{ sectigo_cert_profile_id }}"
      externalRequester: "{{ mails | join(',') }}"
      comments: "{{ sectigo_cert_comments }}"
  register: sectigo1
